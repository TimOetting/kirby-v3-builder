(function () {function c(t){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var a={props:["block","index","columnsCount","pageUid","pageId"],mounted:function(){this.block.isNew?this.$nextTick(function(){this.pending=!1}):this.pending=!1,this.block.content._uid||(this.block.content._uid=this.block.content._key+"_"+new Date().valueOf()+"_"+this._uid),this.activeFieldSet||(this.activeFieldSet=this.fieldSets[0].key);var e=JSON.parse(localStorage.getItem(this.localUiStateKey));e?(this.expanded=e.expanded,this.showPreview=e.showPreview,this.activeFieldSet=e.activeFieldSet):this.storeLocalUiState(),this.block.preview&&this.showPreview?this.displayPreview(this.block.preview):this.displayFieldSet(this.activeFieldSet),this.block.isNew&&this.$emit("input")},data:function(){return{pending:!0,activeFieldSet:null,expanded:!0,previewFrameContent:null,previewHeight:0,previewStored:!1,showPreview:!1}},computed:{localUiStateKey:function(){return"kBuilder.uiState.".concat(this.block.content._uid)},extendedUid:function(){return this.pageId.replace("/","-")+"-"+this._uid},previewUrl:function(){return this.previewStored?"kirby-builder-preview/"+this.extendedUid+"?"+this.objectToGetParams(this.block.preview)+"&pageid="+this.pageId:null},fieldSets:function(){var e=[];if(this.block.tabs){for(var t in this.block.tabs)if(this.block.tabs.hasOwnProperty(t)){var i=this.block.tabs[t];e.push(this.newFieldSet(i,t,this.block.content))}}else this.block.fields&&e.push(this.newFieldSet(this.block,"content",this.block.content,"edit",this.$t("edit")));return e}},methods:{onBlockInput:function(e){this.$emit("input",this.val)},displayPreview:function(){var e=this;this.showPreview=!0,this.expanded=!0;var t={preview:this.block.preview,blockcontent:this.block.content,blockUid:this.extendedUid};this.$api.post("kirby-builder/preview",t).then(function(){e.previewStored=!0}),this.storeLocalUiState()},displayFieldSet:function(e){this.showPreview=!1,this.activeFieldSet=e,this.previewHeight=0,this.storeLocalUiState()},onPreviewLoaded:function(e){this.previewHeight=e.detail.height,this.activeFieldSet=null},toggleExpand:function(e){this.expanded="boolean"==typeof e?e:!this.expanded,this.storeLocalUiState()},newFieldSet:function(e,t,i,n,o){var s={fields:e.fields,key:t,model:i,icon:n||e.icon||null,label:o||e.label||null};return s},objectToGetParams:function(e){return Object.keys(e).map(function(t){return t+"="+e[t]}).join("&")},storeLocalUiState:function(){var e={expanded:this.expanded,showPreview:this.showPreview,activeFieldSet:this.activeFieldSet};localStorage.setItem(this.localUiStateKey,JSON.stringify(e))},tabIcon:function(e){return e?e.indexOf("/")>-1&&e.indexOf(".")>-1?null:e:null},tabImage:function(e){return e&&e.indexOf("/")>-1&&e.indexOf(".")>-1?e:null}}};if(typeof a==="function"){a=a.options}Object.assign(a,function(){var render=function(){var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c("div",{class:["kBuilderBlock","kBuilderBlock--col-"+_vm.columnsCount,{"kBuilderBlock--pending":_vm.pending}]},[_c("div",{class:"kBuilderBlock__header kBuilderBlock__header--col-"+_vm.columnsCount},[_c("k-icon",{class:"kBuilder__dragDropHandle kBuilder__dragDropHandle--col-"+_vm.columnsCount,attrs:{"type":"sort"}}),_vm._v(" "),_c("span",{staticClass:"kBuilderBlock__label",on:{"click":_vm.toggleExpand}},[_c("k-icon",{staticClass:"kBuilderBlock__expandedIcon",class:{"kBuilderBlock__expandedIcon--expanded":_vm.expanded},attrs:{"type":"angle-down"}}),_vm._v(" "+_vm._s(_vm.block.label)+" ")],1),_vm._v(" "),_c("div",{staticClass:"kBuilderBlock__actions"},[_c("k-button-group",{staticClass:"kBuilderBlock__actionsGroup"},[_vm._l(_vm.fieldSets,function(fieldSet){return _vm.fieldSets.length>1||_vm.block.preview?_c("k-button",{key:"showFierldSetButton-"+_vm._uid+fieldSet.key,staticClass:"kBuilderBlock__actionsButton",class:{"kBuilderBlock__actionsButton--active":_vm.activeFieldSet==fieldSet.key&&_vm.expanded},attrs:{"icon":_vm.tabIcon(fieldSet.icon),"image":_vm.tabImage(fieldSet.icon)},on:{"click":function($event){_vm.displayFieldSet(fieldSet.key);_vm.toggleExpand(true)}}},[_vm._v(_vm._s(fieldSet.label))]):_vm._e()}),_vm._v(" "),_vm.block.preview?_c("k-button",{staticClass:"kBuilderBlock__actionsButton",class:{"kBuilderBlock__actionsButton--active":_vm.showPreview&&_vm.expanded},attrs:{"icon":"preview"},on:{"click":function($event){_vm.displayPreview()}}}):_vm._e()],2),_vm._v(" "),_c("div",{staticClass:"kBuilderBlock__control"},[_c("k-dropdown",{staticClass:"kBuilderBlock__actionsDropDown"},[_c("k-button",{staticClass:"kBuilderBlock__actionsButton",attrs:{"icon":"dots"},on:{"click":function($event){_vm.$refs["blockActions"+_vm.block.uniqueKey].toggle()}}}),_vm._v(" "),_c("k-dropdown-content",{ref:"blockActions"+_vm.block.uniqueKey},[_c("k-dropdown-item",{attrs:{"icon":"copy"},on:{"click":function($event){_vm.$emit("clone",_vm.index)}}},[_vm._v(_vm._s(_vm.$t("builder.clone")))]),_vm._v(" "),_c("k-dropdown-item",{attrs:{"icon":"trash"},on:{"click":function($event){_vm.$emit("delete",_vm.index)}}},[_vm._v(_vm._s(_vm.$t("delete")))])],1)],1)],1)],1)],1),_vm._v(" "),_c("div",{directives:[{name:"show",rawName:"v-show",value:_vm.expanded,expression:"expanded"}],staticClass:"kBuilderBlock__content"},[_vm.block.preview&&_vm.showPreview&&_vm.previewUrl?_c("iframe",{staticClass:"kBuilder__previewFrame",style:{height:_vm.previewHeight+"px"},attrs:{"src":_vm.previewUrl},on:{"loaded":_vm.onPreviewLoaded}}):_vm._e(),_vm._v(" "),_vm._l(_vm.fieldSets,function(fieldSet){return _vm.activeFieldSet===fieldSet.key?_c("k-fieldset",_vm._g({key:fieldSet.key+_vm._uid,staticClass:"kBuilderBlock__form",attrs:{"value":{},"fields":fieldSet.fields,"validate":true},model:{value:fieldSet.model,callback:function($$v){_vm.$set(fieldSet,"model",$$v)},expression:"fieldSet.model"}},_vm.$listeners)):_vm._e()})],2)])};var staticRenderFns=[];return{render:render,staticRenderFns:staticRenderFns,_compiled:true,_scopeId:null,functional:undefined}}());var b={props:{value:String,fieldsets:Object,columns:Number,limit:Number,label:String,preview:Object,pageId:String,pageUid:String},components:{BuilderBlock:a},mounted:function(){var t=this;this.value&&(this.value.forEach(function(e,i){var n=t.fieldsets[e._key];t.blocks.push(t.newBlock(n,e._key,e,i))}),this.lastUniqueKey=this.value.length)},data:function(){return{blocks:[],toggle:!0,targetPosition:null,lastUniqueKey:0,dataField:{label:"date label",type:"date"},dateValue:null}},computed:{val:function(){return this.blocks.map(function(t){return t.content})},columnsCount:function(){return this.columns?this.columns:"1"},columnWidth:function(){return this.columns?"1/"+this.columns:"1/1"},draggableOptions:function(){return{group:"kirby-builder",put:"kirby-builder",clone:!0,forceFallback:!0,handle:".kBuilder__dragDropHandle",scroll:!0}},blockCount:function(){return this.blocks.length},fieldsetCount:function(){return Object.keys(this.fieldsets).length},fieldsetKeys:function(){return Object.keys(this.fieldsets)},addBlockButtonLabel:function(){return 1==this.fieldsetCount?"".concat(this.$t("add")," ").concat(this.fieldsets[Object.keys(this.fieldsets)[0]].label):this.$t("add")},supportedBlockTypes:function(){return Object.keys(this.fieldsets)}},methods:{onBlockInput:function(t){this.$emit("input",this.val)},onBlockMoved:function(t){this.$emit("input",this.val)},onBlockAdded:function(t){this.$emit("input",this.val)},onBlockRemoved:function(t){this.$emit("input",this.val)},onMove:function(t){var e=t.relatedContext.index!=this.blocks.length+1,i=0==this.blocks.length,n=this.supportedBlockTypes.includes(t.relatedContext.element.blockKey);return(i||e)&&n},onClickAddBlock:function(t){this.targetPosition=t,1==this.fieldsetCount?this.addBlock(this.fieldsetKeys[0]):this.$refs.dialog.open()},addBlock:function(t){var e=null==this.targetPosition?this.blocks.length:this.targetPosition,i=this.fieldsets[t],n=this.newBlock(i,t,this.getBlankContent(t,i),this.lastUniqueKey++);n.isNew=!0,this.blocks.splice(e,0,JSON.parse(JSON.stringify(n))),this.$refs.dialog.close(),this.targetPosition=null,this.$emit("input",this.val)},getBlankContent:function(t,e){var i={_key:t};if(e.fields)Object.keys(e.fields).forEach(function(t){i[t]=e.fields[t].value||e.fields[t].default||""});else if(e.tabs)for(var n in e.tabs)e.tabs.hasOwnProperty(n)&&function(){var t=e.tabs[n];Object.keys(t.fields).forEach(function(e){i[e]=t.fields[e].value||t.fields[e].default||""})}();return i},cloneBlock:function(t){var e=JSON.parse(JSON.stringify(this.blocks[t]));e.isNew=!0,this.deepRemoveProperty(e.content,"_uid"),this.blocks.splice(t+1,0,e),this.blocks[t+1].uniqueKey=this.lastUniqueKey++,this.$emit("input",this.val)},deleteBlock:function(t){this.clearLocalUiStates(this.blocks[t]),this.blocks.splice(t,1),this.$emit("input",this.val)},deepRemoveProperty:function(t,e){var i=this;Object.keys(t).forEach(function(n){n===e?delete t[n]:"object"===c(t[n])&&i.deepRemoveProperty(t[n],e)})},clearLocalUiStates:function(t){for(var e in t)if(t.hasOwnProperty(e)){t[e];"_uid"===e?localStorage.removeItem("kBuilder.uiState.".concat(t[e])):"object"===c(t[e])&&this.clearLocalUiStates(t[e])}},newBlock:function(t,e,i,n){return{fields:t.fields?t.fields:null,tabs:t.tabs?t.tabs:null,blockKey:e,content:i,label:t.label,uniqueKey:n,preview:t.preview,showPreview:!1}}}};if(typeof b==="function"){b=b.options}Object.assign(b,function(){var render=function(){var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c("k-field",{staticClass:"kBuilder",class:"kBuilder--col-"+_vm.columnsCount,attrs:{"label":_vm.label}},[_c("k-draggable",{staticClass:"kBuilder__blocks k-grid",attrs:{"move":_vm.onMove,"options":_vm.draggableOptions},on:{"end":function($event){_vm.drag=false},"update":_vm.onBlockMoved,"add":_vm.onBlockAdded,"remove":_vm.onBlockRemoved},model:{value:_vm.blocks,callback:function($$v){_vm.blocks=$$v},expression:"blocks"}},[_vm._l(_vm.blocks,function(block,index){return _c("k-column",{key:block.uniqueKey,staticClass:"kBuilder__column",attrs:{"width":_vm.columnWidth}},[_c("div",{staticClass:"kBuilder__inlineAddButton",class:{"kBuilder__inlineAddButton--horizontal":_vm.columnsCount==1,"kBuilder__inlineAddButton--vertical":_vm.columnsCount>1},on:{"click":function($event){_vm.onClickAddBlock(index)}}}),_vm._v(" "),_c("builder-block",{attrs:{"page-id":_vm.pageId,"page-uid":_vm.pageUid,"block":block,"index":index,"columns-count":_vm.columnsCount,"show-preview":block.showPreview},on:{"update:showPreview":function($event){_vm.$set(block,"showPreview",$event)},"input":_vm.onBlockInput,"clone":_vm.cloneBlock,"delete":_vm.deleteBlock}}),_vm._v(" "),_vm.columnsCount%index==0&&_vm.columnsCount>1?_c("div",{staticClass:"kBuilder__inlineAddButton kBuilder__inlineAddButton--vertical kBuilder__inlineAddButton--after",on:{"click":function($event){_vm.onClickAddBlock(index+1)}}}):_vm._e()],1)}),_vm._v(" "),!_vm.limit||_vm.blockCount<_vm.limit?_c("k-column",{attrs:{"width":_vm.columnWidth}},[_c("k-button",{staticClass:"kBuilder__addButton",attrs:{"icon":"add"},on:{"click":function($event){_vm.onClickAddBlock()}}},[_vm._v(" "+_vm._s(_vm.addBlockButtonLabel)+" ")])],1):_vm._e()],2),_vm._v(" "),_c("k-dialog",{ref:"dialog"},[_c("k-list",_vm._l(_vm.fieldsets,function(value,key){return _c("k-list-item",{key:key,staticClass:"kBuilder__addBlockButton",attrs:{"text":value.label},on:{"click":function($event){_vm.addBlock(key)}}})}))],1)],1)};var staticRenderFns=[];return{render:render,staticRenderFns:staticRenderFns,_compiled:true,_scopeId:null,functional:undefined}}());panel.plugin("timoetting/k-builder",{fields:{builder:b}});})();